{% extends 'core/base.html' %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
<link rel="stylesheet" href="{% static 'booking/css/style_metro.css' %}">
<style>
    .hidden { display: none; }

    .selection-section {
        background: rgba(85, 85, 85, 0.95);
        padding: 25px;
        margin: 20px 0;
        border-radius: 10px;
        color: #f0f0f0;
        position: relative;
        z-index: 2; /* —á—Ç–æ–±—ã –∫–ª–∏–∫–∏ —Ä–∞–±–æ—Ç–∞–ª–∏ */
    }

    .btn-choice {
        margin: 10px 0;
        padding: 15px;
        font-size: 1.1em;
        width: 100%;
        transition: all 0.3s ease;
        background-color: #666;
        border: none;
        color: white;
    }
    .btn-choice:hover {
        background-color: #777;
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }

    .form-section {
        margin: 25px 0;
        padding: 20px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 8px;
    }

    .form-control {
        background: rgba(255, 255, 255, 0.85);
        border: 1px solid #ccc;
        color: #222;
    }
    .form-control:focus {
        background: white;
        color: #111;
    }

    h2, h5 {
        color: #fff;
        margin-bottom: 20px;
    }
    label {
        color: #eee;
        font-weight: bold;
        margin-bottom: 8px;
        display: block;
    }

    h5::first-letter,
    h5 span.emoji {
        filter: brightness(0.8);
    }

    /* –∫–Ω–æ–ø–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ */
    .btn-success {
        background-color: #28a745;
        border: none;
    }
    .btn-success:hover {
        background-color: #2ecc71;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2 class="text-center">–ó–∞–ø–∏—Å—å –Ω–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É</h2>

    {% if messages %}
        <div class="alert alert-success">
            {% for message in messages %}
                <p>{{ message }}</p>
            {% endfor %}
        </div>
    {% endif %}

    <form method="post" novalidate id="booking-form">
        {% csrf_token %}

        <!-- –î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è -->
        <div class="selection-section">
            <h5>üìÖ –î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏</h5>
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="{{ form.date.id_for_label }}">–î–∞—Ç–∞ *</label>
                        {{ form.date }}
                        {% for error in form.date.errors %}
                            <div class="text-danger">{{ error }}</div>
                        {% endfor %}
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="{{ form.time.id_for_label }}">–í—Ä–µ–º—è *</label>
                        {{ form.time }}
                        {% for error in form.time.errors %}
                            <div class="text-danger">{{ error }}</div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- –í—ã–±–æ—Ä —Å–ø–æ—Å–æ–±–∞ –∑–∞–ø–∏—Å–∏ -->
        <div class="selection-section">
            <h5>üéØ –í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–± –∑–∞–ø–∏—Å–∏</h5>
            <div class="row">
                <div class="col-md-6">
                    <button type="button" class="btn btn-primary btn-choice" id="choose-trainer-first">
                        <strong>üë®‚Äçüè´ –°–Ω–∞—á–∞–ª–∞ –≤—ã–±—Ä–∞—Ç—å —Ç—Ä–µ–Ω–µ—Ä–∞</strong><br>
                        <small>–ó–∞—Ç–µ–º –≤—ã–±—Ä–∞—Ç—å –µ–≥–æ –∫—É—Ä—Å</small>
                    </button>
                </div>
                <div class="col-md-6">
                    <button type="button" class="btn btn-primary btn-choice" id="choose-course-first">
                        <strong>üìö –°–Ω–∞—á–∞–ª–∞ –≤—ã–±—Ä–∞—Ç—å –∫—É—Ä—Å</strong><br>
                        <small>–ó–∞—Ç–µ–º –≤—ã–±—Ä–∞—Ç—å —Ç—Ä–µ–Ω–µ—Ä–∞</small>
                    </button>
                </div>
            </div>
        </div>

        <!-- –ë–ª–æ–∫ –≤—ã–±–æ—Ä–∞ —Ç—Ä–µ–Ω–µ—Ä–∞ (–∏–∑–Ω–∞—á–∞–ª—å–Ω–æ —Å–∫—Ä—ã—Ç) -->
        <div class="selection-section hidden" id="trainer-selection">
            <h5>üë®‚Äçüè´ –í—ã–±–µ—Ä–∏—Ç–µ —Ç—Ä–µ–Ω–µ—Ä–∞</h5>
            <div class="form-group">
                <select id="trainer-select" class="form-control">
                    <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —Ç—Ä–µ–Ω–µ—Ä–∞ --</option>
                    {% for trainer in trainers %}
                        <option value="{{ trainer.id }}">{{ trainer.name }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <!-- –ë–ª–æ–∫ –≤—ã–±–æ—Ä–∞ –∫—É—Ä—Å–∞ —Ç—Ä–µ–Ω–µ—Ä–∞ (—Å–∫—Ä—ã—Ç) -->
        <div class="selection-section hidden" id="trainer-courses">
            <h5>üìö –í—ã–±–µ—Ä–∏—Ç–µ –∫—É—Ä—Å —Ç—Ä–µ–Ω–µ—Ä–∞</h5>
            <div class="form-group">
                <select id="trainer-course-select" class="form-control" name="course">
                    <option value="">-- –°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Ç—Ä–µ–Ω–µ—Ä–∞ --</option>
                </select>
            </div>
        </div>

        <!-- –ë–ª–æ–∫ –≤—ã–±–æ—Ä–∞ –∫—É—Ä—Å–∞ (–∏–∑–Ω–∞—á–∞–ª—å–Ω–æ —Å–∫—Ä—ã—Ç) -->
        <div class="selection-section hidden" id="course-selection">
            <h5>üìö –í—ã–±–µ—Ä–∏—Ç–µ –∫—É—Ä—Å</h5>
            <div class="form-group">
                <select id="course-select" class="form-control">
                    <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –∫—É—Ä—Å --</option>
                    {% for course in courses %}
                        <option value="{{ course.id }}">{{ course.title }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <!-- –ë–ª–æ–∫ –≤—ã–±–æ—Ä–∞ —Ç—Ä–µ–Ω–µ—Ä–∞ –∫—É—Ä—Å–∞ (—Å–∫—Ä—ã—Ç) -->
        <div class="selection-section hidden" id="course-trainers">
            <h5>üë®‚Äçüè´ –í—ã–±–µ—Ä–∏—Ç–µ —Ç—Ä–µ–Ω–µ—Ä–∞ –¥–ª—è –∫—É—Ä—Å–∞</h5>
            <div class="form-group">
                <select id="course-trainer-select" class="form-control" name="trainer">
                    <option value="">-- –°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∫—É—Ä—Å --</option>
                </select>
            </div>
        </div>

        <!-- –°–∫—Ä—ã—Ç—ã–µ –ø–æ–ª—è —Ñ–æ—Ä–º—ã -->
        <div class="hidden">
            {{ form.trainer }}
            {{ form.course }}
        </div>

        <!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è (–ø–æ—è–≤–ª—è—é—Ç—Å—è –ø–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è) -->
        <div class="selection-section hidden" id="contact-fields">
            <h5>üë§ –í–∞—à–∏ –∫–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</h5>

            <div class="row">
                <div class="col-md-12">
                    <div class="form-group">
                        <label>üìç –ë–ª–∏–∂–∞–π—à–∞—è —Å—Ç–∞–Ω—Ü–∏—è –º–µ—Ç—Ä–æ *</label>
                        {{ form.metro }}
                        {% for error in form.metro.errors %}
                            <div class="text-danger">{{ error }}</div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label>üë§ –í–∞—à–µ –∏–º—è *</label>
                        {{ form.name }}
                        {% for error in form.name.errors %}
                            <div class="text-danger">{{ error }}</div>
                        {% endfor %}
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label>üìû –¢–µ–ª–µ—Ñ–æ–Ω *</label>
                        {{ form.phone }}
                        {% for error in form.phone.errors %}
                            <div class="text-danger">{{ error }}</div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <div class="row mt-4">
                <div class="col-md-12">
                    <button type="submit" class="btn btn-success btn-lg w-100">
                        ‚òëÔ∏è –ó–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É
                    </button>
                </div>
            </div>
        </div>

        <!-- –ö–Ω–æ–ø–∫–∞ –æ—Ç–º–µ–Ω—ã -->
        <div class="text-center mt-3">
            <button type="button" class="btn btn-outline-light" id="cancel-selection" style="display: none;">
                üîÑ –ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ
            </button>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
<script>
$(document).ready(function() {
    let selectionPath = null;

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∞–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –º–µ—Ç—Ä–æ
    $('#id_metro').autocomplete({
        source: "{% static 'metro_stations.json' %}",
        minLength: 2,
        delay: 300
    });

    // –§—É–Ω–∫—Ü–∏—è —Å–±—Ä–æ—Å–∞ –≤—ã–±–æ—Ä–∞
    function resetSelection() {
        selectionPath = null;
        $('#trainer-selection, #course-selection, #trainer-courses, #course-trainers, #contact-fields').addClass('hidden');
        $('#choice-buttons').show();
        $('#trainer-select, #course-select').val('');
        $('#id_trainer, #id_course').val('');
        $('#cancel-selection').hide();
        $('#choose-trainer-first, #choose-course-first').removeClass('btn-success').addClass('btn-primary');
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ –æ—Ç–º–µ–Ω—ã
    $('#cancel-selection').click(function() {
        resetSelection();
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –≤—ã–±–æ—Ä–∞ –ø—É—Ç–∏
    $('#choose-trainer-first').click(function() {
        selectionPath = 'trainer';
        $('#trainer-selection').removeClass('hidden');
        $('#course-selection').addClass('hidden');
        $('#choose-trainer-first').removeClass('btn-primary').addClass('btn-success');
        $('#choose-course-first').removeClass('btn-success').addClass('btn-primary');
        $('#cancel-selection').show();
    });

    $('#choose-course-first').click(function() {
        selectionPath = 'course';
        $('#course-selection').removeClass('hidden');
        $('#trainer-selection').addClass('hidden');
        $('#choose-course-first').removeClass('btn-primary').addClass('btn-success');
        $('#choose-trainer-first').removeClass('btn-success').addClass('btn-primary');
        $('#cancel-selection').show();
    });

    // –ó–∞–≥—Ä—É–∑–∫–∞ –∫—É—Ä—Å–æ–≤ —Ç—Ä–µ–Ω–µ—Ä–∞
    $('#trainer-select').change(function() {
        const trainerId = $(this).val();
        if (trainerId) {
            $.get(`/booking/get-trainer-courses/${trainerId}/`, function(data) {
                const $select = $('#trainer-course-select');
                $select.empty().append('<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –∫—É—Ä—Å --</option>');
                if (data.length > 0) {
                    data.forEach(function(course) {
                        $select.append(`<option value="${course.id}">${course.name}</option>`);
                    });
                    $('#trainer-courses').removeClass('hidden');
                    $('#id_trainer').val(trainerId);
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ –ø–æ–ª—è, —Ç–∞–∫ –∫–∞–∫ —Ç—Ä–µ–Ω–µ—Ä –≤—ã–±—Ä–∞–Ω
                    $('#contact-fields').removeClass('hidden');
                } else {
                    $('#trainer-courses').addClass('hidden');
                    alert('–£ —ç—Ç–æ–≥–æ —Ç—Ä–µ–Ω–µ—Ä–∞ –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫—É—Ä—Å–æ–≤');
                }
            }).fail(function() {
                alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫—É—Ä—Å–æ–≤');
            });
        } else {
            $('#trainer-courses').addClass('hidden');
            $('#id_trainer').val('');
            $('#contact-fields').addClass('hidden');
        }
    });

    // –ó–∞–≥—Ä—É–∑–∫–∞ —Ç—Ä–µ–Ω–µ—Ä–æ–≤ –∫—É—Ä—Å–∞
    $('#course-select').change(function() {
        const courseId = $(this).val();
        if (courseId) {
            $.get(`/booking/get-course-trainers/${courseId}/`, function(data) {
                const $select = $('#course-trainer-select');
                $select.empty().append('<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —Ç—Ä–µ–Ω–µ—Ä–∞ --</option>');
                if (data.length > 0) {
                    data.forEach(function(trainer) {
                        $select.append(`<option value="${trainer.id}">${trainer.name}</option>`);
                    });
                    $('#course-trainers').removeClass('hidden');
                    $('#id_course').val(courseId);
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ –ø–æ–ª—è, —Ç–∞–∫ –∫–∞–∫ –∫—É—Ä—Å –≤—ã–±—Ä–∞–Ω
                    $('#contact-fields').removeClass('hidden');
                } else {
                    $('#course-trainers').addClass('hidden');
                    alert('–î–ª—è —ç—Ç–æ–≥–æ –∫—É—Ä—Å–∞ –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ç—Ä–µ–Ω–µ—Ä–æ–≤');
                }
            }).fail(function() {
                alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç—Ä–µ–Ω–µ—Ä–æ–≤');
            });
        } else {
            $('#course-trainers').addClass('hidden');
            $('#id_course').val('');
            $('#contact-fields').addClass('hidden');
        }
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –≤—ã–±–æ—Ä–∞ –∫—É—Ä—Å–∞ —Ç—Ä–µ–Ω–µ—Ä–∞ –∏ —Ç—Ä–µ–Ω–µ—Ä–∞ –∫—É—Ä—Å–∞
    $('#trainer-course-select').change(function() {
        $('#id_course').val($(this).val());
    });

    $('#course-trainer-select').change(function() {
        $('#id_trainer').val($(this).val());
    });

    // –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–æ—Ä–º—ã –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ
    $('#booking-form').submit(function(e) {
        const trainer = $('#id_trainer').val();
        const course = $('#id_course').val();
        const date = $('#id_date').val();
        const time = $('#id_time').val();

        if (!date || !time) {
            e.preventDefault();
            alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏');
            return false;
        }

        if (!trainer || !course) {
            e.preventDefault();
            alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–≤–µ—Ä—à–∏—Ç–µ –≤—ã–±–æ—Ä —Ç—Ä–µ–Ω–µ—Ä–∞ –∏ –∫—É—Ä—Å–∞');
            return false;
        }

        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞: —Ç—Ä–µ–Ω–µ—Ä –¥–æ–ª–∂–µ–Ω –≤–µ—Å—Ç–∏ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –∫—É—Ä—Å
        if (trainer && course) {
            // –≠—Ç–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –±—É–¥–µ—Ç –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ, –Ω–æ –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –∏ –∑–¥–µ—Å—å
            const selectedTrainerId = $('#trainer-select').val() || $('#course-trainer-select').val();
            const selectedCourseId = $('#course-select').val() || $('#trainer-course-select').val();

            if (selectionPath === 'trainer') {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –∫—É—Ä—Å –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç —Ç—Ä–µ–Ω–µ—Ä—É
                const isValid = $('#trainer-course-select option[value="' + selectedCourseId + '"]').length > 0;
                if (!isValid) {
                    e.preventDefault();
                    alert('–í—ã–±—Ä–∞–Ω–Ω—ã–π –∫—É—Ä—Å –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω —É —ç—Ç–æ–≥–æ —Ç—Ä–µ–Ω–µ—Ä–∞');
                    return false;
                }
            } else if (selectionPath === 'course') {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ç—Ä–µ–Ω–µ—Ä –≤–µ–¥–µ—Ç —ç—Ç–æ—Ç –∫—É—Ä—Å
                const isValid = $('#course-trainer-select option[value="' + selectedTrainerId + '"]').length > 0;
                if (!isValid) {
                    e.preventDefault();
                    alert('–í—ã–±—Ä–∞–Ω–Ω—ã–π —Ç—Ä–µ–Ω–µ—Ä –Ω–µ –≤–µ–¥–µ—Ç —ç—Ç–æ—Ç –∫—É—Ä—Å');
                    return false;
                }
            }
        }
    });

    // –£–ª—É—á—à–µ–Ω–∏–µ: –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ñ–æ–∫—É—Å –Ω–∞ –ø–µ—Ä–≤–æ–º –ø–æ–ª–µ –ø—Ä–∏ –ø–æ–∫–∞–∑–µ —Å–µ–∫—Ü–∏–π
    $(document).on('show', '.selection-section', function() {
        $(this).find('select:first, input:first').focus();
    });
});
</script>
{% endblock %}