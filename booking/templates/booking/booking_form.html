{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
<link rel="stylesheet" href="{% static 'booking/css/style_metro.css' %}">
{% endblock %}

{% block content %}
<div class="container mt-5">
    <h2>Заполните небольшую анкету — и наш менеджер свяжется с вами в течение 5 минут</h2>
    <form method="post" novalidate>
        {% csrf_token %}

        <!-- Дата и время -->
        <div class="row">
            <div class="col-md-6">
                <div class="form-group">
                    <label for="{{ form.date.id_for_label }}">Какую дату для тренировки рассматриваете?</label>
                    {{ form.date }}
                    {% for error in form.date.errors %}
                        <div class="text-danger">{{ error }}</div>
                    {% endfor %}
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group">
                    <label for="{{ form.time.id_for_label }}">Время тренировки</label>
                    {{ form.time }}
                    {% for error in form.time.errors %}
                        <div class="text-danger">{{ error }}</div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Направление -->
        <div class="row mt-3">
            <div class="col-md-12">
                <label>Выберите направление</label>
                {{ form.direction }}
                {% for error in form.direction.errors %}
                    <div class="text-danger">{{ error }}</div>
                {% endfor %}
            </div>
        </div>

        <!-- Тренер -->
        <div class="row mt-3" id="trainer-field" style="display: none;">
            <div class="col-md-12">
                <div class="form-group">
                    <label for="{{ form.trainer.id_for_label }}">Выберите тренера</label>
                    {{ form.trainer }}
                    {% for error in form.trainer.errors %}
                        <div class="text-danger">{{ error }}</div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Услуга -->
        <div class="row mt-3" id="service-field" style="display: none;">
            <div class="col-md-12">
                <div class="form-group">
                    <label for="{{ form.service.id_for_label }}">Выберите услугу</label>
                    {{ form.service }}
                    {% for error in form.service.errors %}
                        <div class="text-danger">{{ error }}</div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Метро -->
        <div class="row mt-3">
            <div class="col-md-12">
                <div class="form-group">
                    <label for="{{ form.metro.id_for_label }}">Станция метро</label>
                    {{ form.metro }}
                    {% for error in form.metro.errors %}
                        <div class="text-danger">{{ error }}</div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Контакты -->
        <div class="row mt-3">
            <div class="col-md-6">
                <div class="form-group">
                    <label for="{{ form.name.id_for_label }}">Ваше имя</label>
                    {{ form.name }}
                    {% for error in form.name.errors %}
                        <div class="text-danger">{{ error }}</div>
                    {% endfor %}
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group">
                    <label for="{{ form.phone.id_for_label }}">Ваш телефон</label>
                    {{ form.phone }}
                    {% for error in form.phone.errors %}
                        <div class="text-danger">{{ error }}</div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Кнопка -->
        <div class="row mt-4">
            <div class="col-md-12">
                <button type="submit" class="btn btn-primary">Отправить заявку</button>
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
<script>
$(document).ready(function() {
    // Проверка загрузки jQuery UI
    if (!$.ui || !$.ui.autocomplete) {
        console.error('jQuery UI не загружен!');
        return;
    }

    // Загрузка станций метро
    fetch("{% static 'metro_stations.json' %}")
        .then(response => {
            if (!response.ok) throw new Error('Ошибка загрузки: ' + response.status);
            return response.json();
        })
        .then(data => {
            console.log('Успешно загружено станций:', data.length);
            $("#id_metro").autocomplete({
                source: data,
                minLength: 2,
                delay: 300
            });
        })
        .catch(error => console.error('Ошибка:', error));

    // Управление видимостью полей
    const updateFieldsVisibility = () => {
        const selected = $("input[name='direction']:checked").val();
        $("#trainer-field").toggle(selected === 'trainer');
        $("#service-field").toggle(selected === 'service');
    };

    $("input[name='direction']").on('change', updateFieldsVisibility);
    updateFieldsVisibility();
});
</script>
{% endblock %}